<?php

function sync_package_spamd() {
	global $config, $g;
	conf_mount_rw();
	config_lock();
	$fd = fopen("/usr/local/etc/spamd.conf","w");
	/* all header */
	fwrite($fd, "# this file was automatically generated by the pfSense\n");
	fwrite($fd, "# package management system\n\n");
	fwrite($fd, "all:\\\n\t:whitelist");
	foreach($config['installedpackages']['spamd']['config'] as $spamd) {
		fwrite($fd, ":" . rtrim($spamd['providername']));
	}
	fwrite($fd, ":\n\n# begin of whitelist\n");
	fwrite($fd, "whitelist:\\\n");
	fwrite($fd, "\t:white:\\\n");
	fwrite($fd, "\t:file=/var/mail/whitelist.txt\n");
	/* loop through each item and write out its configuration */
	fwrite($fd, "\n# begin of user created entries\n");
	if($config['installedpackages']['spamd']['config'] != "") {
		foreach($config['installedpackages']['spamd']['config'] as $spamd) {
			if(rtrim($spamd['providername'])) {
				fwrite($fd, rtrim($spamd['providername']) . ":\\\n");
				fwrite($fd, "\t:" . rtrim($spamd['providertype']) . ":\\\n");
				fwrite($fd, "\t:msg=\"" . rtrim($spamd['rejectmessage']) . "\":\\\n");
				fwrite($fd, "\t:method=" . rtrim($spamd['providermethod']) . ":\\\n");
				fwrite($fd, "\t:" . rtrim($spamd['providermethod']) . ":\\\n");
				fwrite($fd, "\t:file=" . rtrim($spamd['providerurl']) . ":\n\n");
			}
		}
	}
	fclose($fd);
	$fd = fopen("/var/db/whitelist.txt","w");
	if($config['installedpackages']['spamdwhitelist']['config'] != "")
	    foreach($config['installedpackages']['spamdwhitelist']['config'] as $spamd) {
		fwrite($fd, $spamd['ip'] . "\n");
	}
	fclose($fd);
	conf_mount_ro();
	config_unlock();
	
	$passtime = "5:4:864";
	$identifier = "";
	$greylisting = " -g";
	$maxcon = "";
	$maxblack = "";
	$stuttersecs = "";
	$delaysecs = "";
	$pkg = get_pkg_id("spamd");
	$pkg_i = $config['installedpackages']['spamdsettings']['config'];
	if($pkg_i['passtime'] <> "")
		$passtime = $pkg_i['passtime'];
	if($pkg_i['identifier'] <> "")
		$identifier = " -n \"" . $pkg_i['identifier'] . "\"";
	if(isset($pkg_i['greylisting']) <> "")
		$greylisting = $pkg_i['greylisting'];		
	if($pkg_i['maxblack'] <> "")
		$maxblack = " -B " . $pkg_i['maxblack'];
	if($pkg_i['maxcon'] <> "")
		$maxcon = " -c " . $pkg_i['maxcon'];

	if($pkg_i['stuttersecs'] <> "")
		$stuttersecs = " -S " . $pkg_i['stuttersecs'];
	if($pkg_i['delaysecs'] <> "")
		$delaysecs = " -s " . $pkg_i['delaysecs'];

	$start = "/usr/local/sbin/spamd-setup &\n" .
		 "/sbin/pflogd &\n" .
		 "/sbin/mount_fdescfs fdescfs /dev/fd\n" .
		 "/usr/local/libexec/spamd -G {$passtime}{$identifier}{$greylisting}{$maxcon}{$maxblack} -b 127.0.0.1 &\n";
		 "/usr/local/libexec/spamlogd &\n" .
	$stop  = "/usr/bin/killall spamd-setup\n" .
		 "/usr/bin/killall spamd\n" .
		 "/usr/bin/killall mount_fdescfs\n" .
		 "/usr/bin/killall spamlogd\n";
	write_rcfile(array(
				"file" => "spamd.sh",
				"start" => $start,
				"stop" =>  $stop
			    )
	);
	restart_service("spamd");
}

function custom_php_install_command() {
	global $config, $g;
	system("touch /var/db/whitelist.txt");

	sync_package_spamd();
}

function custom_php_deinstall_command() {
	global $config, $g;
	unlink_if_exists("/usr/local/pkg/pf/spamd_rules.php");
	unlink_if_exists("/usr/local/www/spamd_rules.php");
	unlink_if_exists("/usr/local/etc/rc.d/spamd.sh");
}

?>