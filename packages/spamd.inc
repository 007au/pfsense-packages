<?php

function sync_package_spamd() {
	global $config, $g;
	conf_mount_rw();
	config_lock();
	$fd = fopen("/usr/local/etc/spamd.conf","w");
	/* all header */
	fwrite($fd, "# this file was automatically generated by the pfSense\n");
	fwrite($fd, "# package management system\n\n");
	fwrite($fd, "all:\\\n\t:whitelist");
	foreach($config['installedpackages']['spamd']['config'] as $spamd) {
		fwrite($fd, ":" . rtrim($spamd['providername']));
	}
	fwrite($fd, ":\n\n# begin of whitelist\n");
	fwrite($fd, "whitelist:\\\n");
	fwrite($fd, "\t:white:\\\n");
	fwrite($fd, "\t:file=/var/mail/whitelist.txt\n");
	/* loop through each item and write out its configuration */
	fwrite($fd, "\n# begin of user created entries\n");
	if($config['installedpackages']['spamd']['config'] != "") {
		foreach($config['installedpackages']['spamd']['config'] as $spamd) {
			fwrite($fd, rtrim($spamd['providername']) . ":\\\n");
			fwrite($fd, "\t:" . rtrim($spamd['providertype']) . ":\\\n");
			fwrite($fd, "\t:msg=\"" . rtrim($spamd['rejectmessage']) . "\":\\\n");
			fwrite($fd, "\t:method=" . rtrim($spamd['providermethod']) . ":\\\n");
			fwrite($fd, "\t:" . rtrim($spamd['providermethod']) . ":\\\n");
			fwrite($fd, "\t:file=" . rtrim($spamd['providerurl']) . ":\n\n");
		}
	}
	fclose($fd);
	$fd = fopen("/var/db/whitelist.txt","w");
	if($config['installedpackages']['spamdwhitelist']['config'] != "")
	    foreach($config['installedpackages']['spamdwhitelist']['config'] as $spamd) {
		fwrite($fd, $spamd['ip'] . "\n");
	}
	fclose($fd);
	conf_mount_ro();
	config_unlock();
	restart_service("spamd");
}

function custom_php_install_command() {
	global $config, $g;
	system("touch /var/db/whitelist.txt");
	system("/usr/local/libexec/spamd -G 25:4:864");
	system("/usr/libexec/spamlogd 2>/dev/null &");
	$start = "/usr/local/sbin/spamd-setup &\n" .
		 "/sbin/pflogd &\n" .
		 "/sbin/mount_fdescfs fdescfs /dev/fd\n" .
		 "/usr/local/libexec/spamlogd &\n";
		 "/usr/local/libexec/spamd -G 5:4:864 -g -d -b 127.0.0.1 &\n" .
	$stop  = "/usr/bin/killall spamd-setup &\n" .
		 "/usr/bin/killall spamd\n" .
		 "/usr/bin/killall mount_fdescfs\n" .
		 "/usr/bin/killall spamlogd\n";
	write_rcfile(array(
				"file" => "spamd.sh",
				"start" => $start,
				"stop" =>  $stop
			    )
	);
	start_service("spamd");
}

function custom_php_deinstall_command() {
	global $config, $g;
	unlink_if_exists("/usr/local/pkg/spamd.sh");
	unlink_if_exists("/usr/local/pkg/pf/spamd_rules.php");
	unlink_if_exists("/usr/local/www/spamd_rules.php");
}

?>