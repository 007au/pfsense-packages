<?php

function sync_package_spamd() {
	global $config, $g;
	conf_mount_rw();
	config_lock();
	$fd = fopen("/usr/local/etc/spamd.conf","w");
	/* all header */
	fwrite($fd, "# this file was automatically generated by the pfSense\n");
	fwrite($fd, "# package management system\n\n");
	fwrite($fd, "all:\\\n\t:whitelist");
	foreach($config['installedpackages']['spamd']['config'] as $spamd) {
		fwrite($fd, ":" . rtrim($spamd['providername']));
	}
	fwrite($fd, ":\n\n# begin of whitelist\n");
	fwrite($fd, "whitelist:\\\n");
	fwrite($fd, "\t:white:\\\n");
	fwrite($fd, "\t:file=/var/db/whitelist.txt\n");
	/* loop through each item and write out its configuration */
	fwrite($fd, "\n# begin of user created entries\n");
	if($config['installedpackages']['spamdsources']['config'] != "") {
		foreach($config['installedpackages']['spamdsources']['config'] as $spamd) {
			if(rtrim($spamd['providername'])) {
				fwrite($fd, rtrim($spamd['providername']) . ":\\\n");
				fwrite($fd, "\t:" . rtrim($spamd['providertype']) . ":\\\n");
				fwrite($fd, "\t:msg=\"" . rtrim($spamd['rejectmessage']) . "\":\\\n");
				fwrite($fd, "\t:method=" . rtrim($spamd['providermethod']) . ":\\\n");
				fwrite($fd, "\t:" . rtrim($spamd['providermethod']) . ":\\\n");
				fwrite($fd, "\t:file=" . rtrim($spamd['providerurl']) . ":\n\n");
			}
		}
	}
	fclose($fd);
	$fd = fopen("/var/db/whitelist.txt","w");
	if($config['installedpackages']['spamdwhitelist']['config'] != "")
	    foreach($config['installedpackages']['spamdwhitelist']['config'] as $spamd) {
		fwrite($fd, $spamd['ip'] . "\n");
	}
	fclose($fd);
	$passtime = "5";
	$greyexp = "4";
	$whiteexp = "864";
	$identifier = "";
	$greylisting = " -g";
	$maxcon = "";
	$maxblack = "";
	$stuttersecs = "";
	$delaysecs = "";
	if($config['installedpackages']['spamdsettings']['config']) {
		foreach($config['installedpackages']['spamdsettings']['config'] as $ss) {
			if($ss['nextmta'] <> "")
				$nextmta = $ss['nextmta'];
			if($ss['greylistingparms'] <> "")
				$passtime = " -G " . $ss['greylistingparms'];
			if($ss['identifier'] <> "")
				$identifier = " -n \"" . $ss['identifier'] . "\"";
			if(isset($ss['greylisting']) <> "")
				$greylisting = " -g";	
			if($ss['maxblack'] <> "")
				$maxblack = " -B " . $ss['maxblack'];
			if($ss['maxcon'] <> "")
				$maxcon = " -c " . $ss['maxcon'];
			if($ss['stuttersecs'] <> "")
				$stuttersecs = " -S " . $ss['stuttersecs'];
			if($ss['delaysecs'] <> "")
				$delaysecs = " -s " . $ss['delaysecs'];
			if($ss['window'] <> "")
				$window = " -w " . $ss['window'];
			if($ss['replysmtperror'] <> "")
				$replysmtperror = " -r " . $ss['replysmtperror'];
			if($ss['passtime'] <> "")
				$passtime = $ss['passtime'];
			if($ss['greyexp'] <> "")
				$greyexp = $ss['greyexp'];
			if($ss['whiteexp'] <> "")
				$whiteexp = $ss['whiteexp'];			
		}
	}
	$greyparms = " -G {$passtime}:{$greyexp}:{$whiteexp}";
	$start = "/usr/local/sbin/spamd-setup &\n" .
		 "/sbin/pflogd &\n" .
		 "/sbin/mount_fdescfs fdescfs /dev/fd\n" .
		 "/usr/local/libexec/spamd {$greyparms}{$identifier}{$greylisting}{$maxcon}{$maxblack}{$window}{$replysmtperror} -b 127.0.0.1 &\n" .
		 "/usr/local/libexec/spamlogd\n";
	$stop  = "/usr/bin/killall spamd-setup\n" .
		 "/usr/bin/killall spamlogd\n" .
		 "/usr/bin/killall spamd\n" .
		 "/usr/bin/killall pflogd\n" .		 
		 "sleep 2";
	write_rcfile(array(
				"file" => "spamd.sh",
				"start" => $start,
				"stop" =>  $stop
			    )
	);
	conf_mount_ro();
	config_unlock();
	mwexec("/usr/local/etc/rc.d/spamd.sh stop");
	mwexec("/usr/local/etc/rc.d/spamd.sh start");
}

function custom_php_install_command() {
	global $config, $g;
	system("touch /var/db/whitelist.txt");
	sync_package_spamd();
}

function custom_php_deinstall_command() {
	global $config, $g;
	unlink_if_exists("/usr/local/pkg/pf/spamd_rules.php");
	unlink_if_exists("/usr/local/www/spamd_rules.php");
	unlink_if_exists("/usr/local/etc/rc.d/spamd.sh");
}

?>