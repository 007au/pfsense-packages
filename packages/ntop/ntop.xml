<?xml version="1.0" encoding="utf-8" ?>
<packagegui>
	<title>Diagnostics: ntop Settings</title>
	<name>ntop</name>
	<version>3.0</version>
        <savetext>Change</savetext>
	<aftersaveredirect>pkg_edit.php?xml=ntop.xml&amp;id=0</aftersaveredirect>
	<!-- Menu is where this packages menu will appear -->
	<menu>
		<name>ntop Settings</name>
		<tooltiptext>Set ntop settings such as password and port.</tooltiptext>
		<section>Diagnostics</section>
		<url>/pkg_edit.php?xml=ntop.xml&amp;id=0</url>
	</menu>
	<menu>
		<name>ntop</name>
		<tooltiptext>Access ntop</tooltiptext>
		<url>http://$myurl:3000</url>
		<section>Diagnostics</section>
		<depends_on_service>ntop</depends_on_service>
	</menu>
	<service>
                        <name>ntop</name>
                        <rcfile>ntop.sh</rcfile>
                        <executable>ntop</executable>
        </service>
	<tabs>
		<tab>
			<text>ntop Settings</text>
			<url>/pkg_edit.php?xml=ntop.xml&amp;id=0</url>
			<active/>
		</tab>
		<tab>
			<text>Access ntop</text>
			<url>http://$myurl:3000</url>
		</tab>
	</tabs>
        <!-- Do not save invokes a simple input menu and will not update
             the configuration database. -->
	<fields>
		<field>
			<fielddescr>ntop Admin Password</fielddescr>
			<fieldname>password</fieldname>
			<description>Enter the password for the NTOP Web GUI.  Minimum 5 characters.</description>
			<type>password</type>
		</field>
		<field>
			<fielddescr>ntop Admin Password AGAIN</fielddescr>
			<fieldname>passwordagain</fieldname>
			<type>password</type>
		</field>
		<field>
			<fielddescr>Interface</fielddescr>
			<fieldname>interface_array</fieldname>
			<value>lan</value>
			<multiple>true</multiple>
			<size>3</size>
			<type>interfaces_selection</type>
		</field>
    </fields>
	<custom_php_global_functions>
	function sync_package_ntop() {
	    conf_mount_rw();
	    config_lock();
	    global $config;
	    global $input_errors;
	    $ntop_config =&amp; $_POST;
	    $if_final = "";
	    $ifaces_final = "";
	    system("/bin/mkdir -p /var/db/ntop");
	    system("/bin/mkdir -p /var/db/ntop/rrd");
	    system("/bin/mkdir -p /var/db/ntop/rrd/graphics");
	    system("chown nobody:nobody /var/db/ntop");
	    system("chown nobody:nobody /var/db/ntop/rrd/graphics");
	    if($ntop_config['password'] and $ntop_config['passwordagain']) {
		    if($ntop_config['password'] == $ntop_config['passwordagain']) {
			    $first = 0;
			    foreach($_POST['interface_array'] as $iface) {
				$if = convert_friendly_interface_to_real_interface_name($iface);
				if($if) {
				    if($first == 1)
					$ifaces_final .= ",";
				    $ifaces_final .= $if;
				    $first = 1;
				}
			    }
			    exec("/usr/local/bin/ntop --set-admin-password=" . $_POST['password'] . " &amp;", $ntopout);
			    $start = "/usr/local/bin/ntop -i " . $ifaces_final . " -u root -d --ipv4 -M -x 8102 -X 8192 &amp;";
			    write_rcfile(array(
						    "file" => "ntop.sh",
						    "start" => $start,  
						    "stop" => "/usr/bin/killall ntop"
					    )
			    );
			    restart_service("ntop");
		    } else {
			    $input_errors[] = "The provided passwords did not match.";
		    }
	    } else {
		    $input_errors[] = "You must provide (and confirm) ntop's password.";
	    }
	    conf_mount_ro();
	    config_unlock();
	}
	</custom_php_global_functions>
	<custom_add_php_command>
        	sync_package_ntop();
	</custom_add_php_command>
	<custom_php_resync_command>
		sync_package_ntop();
	</custom_php_resync_command>
</packagegui>
