<?xml version="1.0" encoding="utf-8" ?>
<packagegui>
	<name>carp</name>
	<version>0.1.0</version>
	<title>Services: CARP (failover)</title>
	<!-- Menu is where this packages menu will appear -->
	<menu>
	    <name>CARP (failover)</name>
	    <tooltiptext>CARP is a tool to help achieve system redundancy, by having multiple computers creating a single, virtual network interface between them, so that if any machine fails, another can respond instead, and/or allowing a degree of load sharing between systems. CARP is an improvement over the Virtual Router Redundancy Protocol (VRRP) standard. It was developed after VRRP was deemed to be not free enough because of a possibly-overlapping Cisco patent.</tooltiptext>
	    <section>Services</section>
	    <configfile>carp.xml</configfile>
	</menu>
	<tabs>
	    <tab>
		<text>CARP Virtual IPs</text>
		<url>/pkg_edit.php?xml=carp.xml</url>
		<active/>
	    </tab>
	    <tab>
		<text>CARP Status</text>
		<url>carp_status.php</url>
	    </tab>
	    <tab>
		<text>CARP Settings</text>
		<url>pkg_edit.php?xml=carp_settings.xml&amp;id=0</url>
	    </tab>
	</tabs>
    	<additional_files_needed>
	    <prefix>/usr/local/pkg/</prefix>
	    <chmod>a+x</chmod>
	    <item>http://www.pfsense.com/packages/config/carp_settings.xml</item>
	</additional_files_needed>
    	<additional_files_needed>
	    <prefix>/usr/local/pkg/pf/</prefix>
	    <chmod>a+x</chmod>
	    <item>http://www.pfsense.com/packages/config/carp_rules.php</item>
	</additional_files_needed>
    	<additional_files_needed>
	    <prefix>/usr/local/www/</prefix>
	    <chmod>a+x</chmod>
	    <item>http://www.pfsense.com/packages/config/carp_status.php</item>
	</additional_files_needed>
	<!-- configpath gets expanded out automatically and config items will be
         stored in that location -->
	<configpath>['installedpackages']['carp']['config']</configpath>
	<adddeleteeditpagefields>
	    <columnitem>
		    <fielddescr>VHID Group</fielddescr>
		    <fieldname>vhid</fieldname>
	    </columnitem>
	    <columnitem>
		    <fielddescr>Virtual IP Address</fielddescr>
		    <fieldname>ipaddress</fieldname>
	    </columnitem>
	    <columnitem>
		    <fielddescr>Advertising Frequency</fielddescr>
		    <fieldname>advskew</fieldname>
	    </columnitem>
	    <columnitem>
		    <fielddescr>Netmask</fielddescr>
		    <fieldname>netmask</fieldname>
	    </columnitem>
	</adddeleteeditpagefields>
	<!-- fields gets invoked when the user adds or edits a item.   the following items
         will be parsed and rendered for the user as a gui with input, and selectboxes. -->
	<fields>
		<field>
			<fielddescr>Virtual IP Address</fielddescr>
			<fieldname>ipaddress</fieldname>
			<description>Enter the IP Address that you would like to share on both machines</description>
			<type>input</type>
		</field>
		<field>
			<fielddescr>Virtual IP Netmask</fielddescr>
			<fieldname>netmask</fieldname>
			<description>Enter the IP Address's netmask that you would like to share on both machines</description>
			<type>select</type>
			<value>24</value>
			<options>
			    <option><value>1</value><name>1</name></option>
			    <option><value>2</value><name>2</name></option>
			    <option><value>3</value><name>3</name></option>
			    <option><value>4</value><name>4</name></option>
			    <option><value>5</value><name>5</name></option>
			    <option><value>6</value><name>6</name></option>
			    <option><value>7</value><name>7</name></option>
			    <option><value>8</value><name>8</name></option>
			    <option><value>9</value><name>9</name></option>
			    <option><value>10</value><name>10</name></option>
			    <option><value>11</value><name>11</name></option>
			    <option><value>12</value><name>12</name></option>
			    <option><value>13</value><name>13</name></option>
			    <option><value>14</value><name>14</name></option>
			    <option><value>15</value><name>15</name></option>
			    <option><value>16</value><name>16</name></option>
			    <option><value>17</value><name>17</name></option>
			    <option><value>18</value><name>18</name></option>
			    <option><value>19</value><name>19</name></option>
			    <option><value>20</value><name>20</name></option>
			    <option><value>21</value><name>21</name></option>
			    <option><value>22</value><name>22</name></option>
			    <option><value>23</value><name>23</name></option>
			    <option><value>24</value><name>24</name></option>
			    <option><value>25</value><name>25</name></option>
			    <option><value>26</value><name>26</name></option>
			    <option><value>27</value><name>27</name></option>
			    <option><value>28</value><name>28</name></option>
			    <option><value>29</value><name>29</name></option>
			    <option><value>30</value><name>30</name></option>
			    <option><value>30</value><name>31</name></option>
			    <option><value>30</value><name>32</name></option>
			</options>
		</field>
		<field>
			<fielddescr>Virtual IP Password</fielddescr>
			<fieldname>password</fieldname>
			<description>Enter the VHID group password.</description>
			<type>password</type>
		</field>
		<field>
			<fielddescr>VHID Group</fielddescr>
			<fieldname>vhid</fieldname>
			<description>Enter the VHID group that the machines will share</description>
			<type>select</type>
			<value>1</value>
			<options>
			    <option><value>1</value><name>1 (DEFAULT)</name></option>
			    <option><value>2</value><name>2</name></option>
			    <option><value>3</value><name>3</name></option>
			    <option><value>4</value><name>4</name></option>
			    <option><value>5</value><name>5</name></option>
			    <option><value>6</value><name>6</name></option>
			    <option><value>7</value><name>7</name></option>
			    <option><value>8</value><name>8</name></option>
			    <option><value>9</value><name>9</name></option>
			    <option><value>10</value><name>10</name></option>
			    <option><value>11</value><name>11</name></option>
			    <option><value>12</value><name>12</name></option>
			    <option><value>13</value><name>13</name></option>
			    <option><value>14</value><name>14</name></option>
			    <option><value>15</value><name>15</name></option>
			    <option><value>16</value><name>16</name></option>
			    <option><value>17</value><name>17</name></option>
			    <option><value>18</value><name>18</name></option>
			    <option><value>19</value><name>19</name></option>
			    <option><value>20</value><name>20</name></option>
			    <option><value>21</value><name>21</name></option>
			    <option><value>22</value><name>22</name></option>
			    <option><value>23</value><name>23</name></option>
			    <option><value>24</value><name>24</name></option>
			    <option><value>25</value><name>25</name></option>
			    <option><value>26</value><name>26</name></option>
			    <option><value>27</value><name>27</name></option>
			    <option><value>28</value><name>28</name></option>
			    <option><value>29</value><name>29</name></option>
			    <option><value>30</value><name>30</name></option>
			</options>
		</field>
		<field>
			<fielddescr>Advertising Frequency</fielddescr>
			<fieldname>advskew</fieldname>
			<description>The frequency that this machine will advertise</description>
			<type>select</type>
			<value>0</value>
			<options>
			    <option><value>0</value><name>0 (DEFAULT)</name></option>
			    <option><value>1</value><name>1</name></option>
			    <option><value>2</value><name>2</name></option>
			    <option><value>3</value><name>3</name></option>
			    <option><value>4</value><name>4</name></option>
			    <option><value>5</value><name>5</name></option>
			    <option><value>6</value><name>6</name></option>
			    <option><value>7</value><name>7</name></option>
			    <option><value>8</value><name>8</name></option>
			    <option><value>9</value><name>9</name></option>
			    <option><value>10</value><name>10</name></option>
			    <option><value>11</value><name>11</name></option>
			    <option><value>12</value><name>12</name></option>
			    <option><value>13</value><name>13</name></option>
			    <option><value>14</value><name>14</name></option>
			    <option><value>15</value><name>15</name></option>
			    <option><value>16</value><name>16</name></option>
			    <option><value>17</value><name>17</name></option>
			    <option><value>18</value><name>18</name></option>
			    <option><value>19</value><name>19</name></option>
			    <option><value>20</value><name>20</name></option>
			    <option><value>21</value><name>21</name></option>
			    <option><value>22</value><name>22</name></option>
			    <option><value>23</value><name>23</name></option>
			    <option><value>24</value><name>24</name></option>
			    <option><value>25</value><name>25</name></option>
			    <option><value>26</value><name>26</name></option>
			    <option><value>27</value><name>27</name></option>
			    <option><value>28</value><name>28</name></option>
			    <option><value>29</value><name>29</name></option>
			    <option><value>30</value><name>30</name></option>
			</options>
		</field>
	</fields>
	<custom_php_command_before_form>
	    function sync_package_carp() {
		/*
		 *  XXX: find out how many carp and pfsync interfaces are established
		 *       and destroy/down them before sweeping through the list
		 */
		conf_mount_rw();
		config_lock();
		$fout = fopen("/usr/local/etc/rc.d/carp.sh","w");
		fwrite($fout, "#!/bin/sh \n");
		global $config;
		$carp_instances_counter = 0;
		$pfsync_instances_counter = 0;
		if($config['installedpackages']['carp']['config'] != "") {
		      foreach($config['installedpackages']['carp']['config'] as $carp) {
			  /*
			   *  create the carp interface
			   */
			  fwrite($fout, "echo Creating {$pfsync_instances_counter} ...\n");
			  fwrite($fout, "/sbin/ifconfig carp" . $carp_instances_counter . " create\n");
			  $broadcast_address = gen_subnet_max($carp['ipaddress'], $carp['netmask']);
			  if($carp['password'] != "") {
			    $password = " pass " . $carp['password'];
			  }
			  $carp_command = "/sbin/ifconfig carp" . $carp_instances_counter . " " . $carp['ipaddress'] . "/" . $carp['netmask'];
			  $carp_command .= " broadcast " . $broadcast_address . " vhid " . $carp['vhid'] . " advskew " . $carp['advskew'] . $password;
			  if($carp['balancing'] == "true") $using_arp_balance = 1;
			  if($carp['preempt'] == "true") $using_preempt = 1;
			  fwrite($fout, $carp_command . "\n");
			  fwrite($fout, "/sbin/ifconfig carp{$carp_instances_counter} up\n");
			  if($carp['pfsync'] != "") $pfsync = 1;
			  $carp_instances_counter++;
		      }
		  }
		  foreach($config['installedpackages']['carpsettings']['config'] as $carp)
		  if($carp['pfsyncenabled'] != "") {
			$pfsync = 1;
			if($carp['premption'] != "")
				$preempt = 1;
			if($carp['balancing'] != "")
				$using_arp_balance = 1;
			$carp_sync_int = convert_friendly_interface_to_real_interface_name($carp['pfsyncinterface']);
			$carp_sync_ip  = $carp['pfsyncip'];
			fwrite($fout, "/sbin/ifconfig pfsync0 create\n");
			fwrite($fout, "/sbin/ifconfig pfsync0 {$carp_sync_ip}/24\n");
			fwrite($fout, "/sbin/ifconfig pfsync0 syncif " . $carp_sync_int . "\n");
			fwrite($fout, "/sbin/ifconfig pfsync0 up\n");
			$pfsync_instances_counter++;
		  }
		fwrite($fout, "/etc/rc.filter_configure");
		fclose($fout);
		mwexec("chmod a+x /usr/local/etc/rc.d/carp.sh");
		mwexec("/usr/local/etc/rc.d/carp.sh");
		if($using_arp_balance == 1) system("sysctl net.inet.arpbalance=1");
		if($preempt == 1) system("sysctl net.inet.carp.preempt=1");
		conf_mount_ro();
		config_unlock();
	      }
	</custom_php_command_before_form>
	<custom_php_resync_config_command>
	    sync_package_carp();
	</custom_php_resync_config_command>
	<custom_delete_php_command>
	    sync_package_carp();
	</custom_delete_php_command>
	<custom_php_install_command>
	</custom_php_install_command>
	<custom_php_deinstall_command>
	    system("/bin/rm /usr/local/www/carp* 2>/dev/null");
	    system("/bin/rm /usr/local/pkg/carp* 2>/dev/null");
	    system("/bin/rm /usr/local/pkg/pf/carp* 2>/dev/null");
	    system("/bin/rm /usr/local/etc/rc.d/carp* 2>/dev/null");
	</custom_php_deinstall_command>
</packagegui>
