<?xml version="1.0" encoding="utf-8" ?>
<packagegui>
	<name>spamd-whitelist</name>
	<version>0.1.0</version>
	<title>SpamD Whitelist - this list overrides all other blacklists.</title>
	<!-- Menu is where this packages menu will appear -->
	<menu>
		<name>SpamD Whitelist</name>
		<tooltiptext></tooltiptext>
		<section>Services</section>
		<configfile>spamd.xml</configfile>
	</menu>
	<tabs>
		<tab>
			<text>SpamD External Sources</text>
			<url>/pkg.php?xml=spamd.xml</url>
		</tab>
		<tab>
			<text>SpamD Whitelist</text>
			<url>/pkg.php?xml=spamd_whitelist.xml</url>
			<active/>
		</tab>
		<tab>
			<text>SpamD Settings</text>
			<url>/pkg_edit.php?xml=spamd_settings.xml&amp;id=0</url>
		</tab>			
		<tab>
			<text>SpamD Database</text>
			<url>/spamd_db.php</url>
		</tab>
		<tab>
			<text>SpamD Outlook</text>
			<url>/pkg_edit.php?xml=spamd_outlook.xml&amp;id=0</url>
		</tab>			
	</tabs>
	<!-- configpath gets expanded out automatically and config items will be
         stored in that location -->
	<configpath>['installedpackages']['spamdwhitelist']['config']</configpath>
	<adddeleteeditpagefields>
		<columnitem>
			<fielddescr>Exempted IP</fielddescr>
			<fieldname>ip</fieldname>
		</columnitem>
		<columnitem>
			<fielddescr>Description</fielddescr>
			<fieldname>description</fieldname>
		</columnitem>
	</adddeleteeditpagefields>
	<!-- fields gets invoked when the user adds or edits a item.   the following items
         will be parsed and rendered for the user as a gui with input, and selectboxes. -->
	<fields>
		<field>
			<fielddescr>Exempted IP</fielddescr>
			<fieldname>ip</fieldname>
			<description>Enter the IP to exempt from blacklisting</description>
			<type>input</type>
		</field>
		<field>
			<fielddescr>Description</fielddescr>
			<fieldname>description</fieldname>
			<description>Enter the description for this item</description>
			<type>input</type>
		</field>
	</fields>
	<custom_php_command_before_form>
	    function sync_package_spamd_whitelist() {
			global $config;
			conf_mount_rw();
			config_lock();
			/* write out ip to the whitelist db */
			$fd = fopen("/var/db/whitelist.txt","w");
			if($config['installedpackages']['spamdwhitelist']['config'] != "") {
				foreach($config['installedpackages']['spamdwhitelist']['config'] as $spamd) {
					fwrite($fd, $spamd['ip'] . "\n");
			    }
			}
			fclose($fd);
			/* signal a reload of all files */
			mwexec("/usr/bin/killall -HUP spamlogd");
			mwexec("/sbin/pfctl -t spamd-white -T add {$spamd['ip']}");
			conf_mount_ro();
			config_unlock();
	    }
	</custom_php_command_before_form>
	<custom_delete_php_command>
		sync_package_spamd_whitelist();
	</custom_delete_php_command>	
	<custom_php_resync_config_command>
		sync_package_spamd_whitelist();
	</custom_php_resync_config_command>
</packagegui>