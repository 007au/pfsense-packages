<?xml version="1.0" encoding="utf-8" ?>
<packagegui>
	<name>spamd</name>
	<version>0.1.0</version>
	<title></title>
	<!-- Menu is where this packages menu will appear -->
	<menu>
		<name>SpamD</name>
		<tooltiptext></tooltiptext>
		<section>Services</section>
		<configfile>spamd.xml</configfile>
	</menu>
	<tabs>
		<tab>
			<text>SpamD Settings</text>
			<url>/pkg.php?xml=spamd.xml</url>
			<active/>
		</tab>
		<tab>
			<text>SpamD Whitelist</text>
			<url>/pkg.php?xml=spamd_whitelist.xml</url>
		</tab>
	</tabs>
    	<additional_files_needed>
	    <prefix>/usr/local/www/</prefix>
	    <chmod>a+rx</chmod>
	    <item>http://www.pfsense.com/packages/config/spamd_rules.php</item>
	</additional_files_needed>
    	<additional_files_needed>
	    <prefix>/usr/local/pkg/</prefix>
	    <chmod>a+rx</chmod>
	    <item>http://www.pfsense.com/packages/config/spamd_whitelist.xml</item>
	</additional_files_needed>	
	<!-- configpath gets expanded out automatically and config items will be
         stored in that location -->
	<configpath>['installedpackages']['spamd']['config']</configpath>
	<adddeleteeditpagefields>
		<columnitem>
			<fielddescr>Provider Name</fielddescr>
			<fieldname>providername</fieldname>
		</columnitem>
		<columnitem>
			<fielddescr>Description</fielddescr>
			<fieldname>providerdescription</fieldname>
		</columnitem>
	</adddeleteeditpagefields>
	<!-- fields gets invoked when the user adds or edits a item.   the following items
         will be parsed and rendered for the user as a gui with input, and selectboxes. -->
	<fields>
		<field>
			<fielddescr>Provider Name</fielddescr>
			<fieldname>providername</fieldname>
			<description>Enter the name of the source</description>
			<size>30</size>
			<type>input</type>
		</field>
		<field>
			<fielddescr>Provider Type</fielddescr>
			<fieldname>providertype</fieldname>
			<description>Select the Provider Type</description>
			<type>select</type>
			<value>black</value>
			<size>1</size>
			<options>
			    <option><value>black</value><name>Black List</name></option>
			    <option><value>white</value><name>White List</name></option>
			</options>
		</field>
		<field>
			<fielddescr>Provider Description</fielddescr>
			<fieldname>providerdescription</fieldname>
			<description>Enter the description for this item</description>
			<type>input</type>
			<size>30</size>
		</field>
		<field>
			<fielddescr>Reject message</fielddescr>
			<fieldname>rejectmessage</fieldname>
			<description>Enter the message to display to emailing parties that are on this providers list</description>
			<type>input</type>
			<size>30</size>
		</field>
		<field>
			<fielddescr>Provider Method</fielddescr>
			<fieldname>providermethod</fieldname>
			<description>Select the Provider Method</description>
			<type>select</type>
			<value>http</value>
			<size>1</size>
			<options>
			    <option><value>http</value><name>URL</name></option>
			    <option><value>exec</value><name>Execute command</name></option>
			</options>
		</field>
		<field>
			<fielddescr>Provider URL or Filename</fielddescr>
			<fieldname>providerurl</fieldname>
			<description>Enter the URL to the provider.</description>
			<rows>3</rows>
			<cols>40</cols>
			<type>textarea</type>
		</field>
	</fields>
	<custom_php_command_before_form>
	    function sync_package_spamd() {
		conf_mount_rw();
		config_lock();
		global $config;
		$fd = fopen("/usr/local/etc/spamd.conf","w");
		/* all header */
		fwrite($fd, "# this file was automatically generated by the pfSense\n");
		fwrite($fd, "# package management system\n\n");
		fwrite($fd, "all:\\\n\t:whitelist");
		foreach($config['installedpackages']['spamd']['config'] as $spamd) {
		    fwrite($fd, ":" . rtrim($spamd['providername']));
		}
		fwrite($fd, ":\n\n# begin of whitelist\n");
		fwrite($fd, "whitelist:\\\n");
		fwrite($fd, "\t:white:\\\n");
	        fwrite($fd, "\t:file=/var/mail/whitelist.txt\n");
		/* loop through each item and write out its configuration */
		fwrite($fd, "\n# begin of user created entries\n");
		foreach($config['installedpackages']['spamd']['config'] as $spamd) {
		    fwrite($fd, rtrim($spamd['providername']) . ":\\\n");
		    fwrite($fd, "\t:" . rtrim($spamd['providertype']) . ":\\\n");
		    fwrite($fd, "\t:msg=\"" . rtrim($spamd['rejectmessage']) . "\":\\\n");
		    fwrite($fd, "\t:method=" . rtrim($spamd['providermethod']) . ":\\\n");
		    fwrite($fd, "\t:" . rtrim($spamd['providermethod']) . ":\\\n");
		    fwrite($fd, "\t:file=" . rtrim($spamd['providerurl']) . ":\n\n");
		}
		fclose($fd);
		$fd = fopen("/var/mail/whitelist.txt","w");
		if($config['installedpackages']['spamdwhitelist']['config'] != "")
		    foreach($config['installedpackages']['spamdwhitelist']['config'] as $spamd) {
			fwrite($fd, $spamd['ip'] . "\n");
		    }
		fclose($fd);
		system("/usr/local/etc/rc.d/spamd 2>/dev/null");
		conf_mount_ro();
		config_unlock();
	    }
	</custom_php_command_before_form>
	<custom_php_resync_config_command>
	    sync_package_spamd();
	</custom_php_resync_config_command>
	<custom_delete_php_command>
	    sync_package_spamd();
	</custom_delete_php_command>
	<custom_php_install_command>
	    system("touch /var/mail/whitelist.txt 2>/dev/null");
	    system("/usr/libexec/spamd-setup 2>/dev/null &amp;");
	    system("/usr/libexec/spamlogd 2>/dev/null &amp;");
	    $fd = fopen("/usr/local/etc/rc.d/spamd","w");
	    fwrite($fd, "#!/bin/sh\n\n");
	    fwrite($fd, "# PACKAGE: STunnel\n");
	    fwrite($fd, "# EXECUTABLE: stunnel\n");
	    fwrite($fd, "/usr/bin/killall spamd-setup 2>/dev/null\n");
	    fwrite($fd, "/usr/local/sbin/spamd-setup &amp;\n");
	    fwrite($fd, "/usr/local/libexec/spamlogd &amp;\n");
	    fclose($fd);
	    chmod("/usr/local/etc/rc.d/spamd", 0755);
	    mwexec("/usr/local/etc/rc.d/spamd");
	</custom_php_install_command>
	<custom_php_deinstall_command>
	    unlink_if_exists("/usr/local/pkg/spamd*");
	    unlink_if_exists("/usr/local/www/spam*");
	</custom_php_deinstall_command>
</packagegui>
